<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NGL Versi Kamu ‚Äî Dengan Info Pengirim</title>
<style>
  body{font-family:Inter,system-ui,Arial;padding:24px;background:linear-gradient(135deg,#0f172a,#0ea5a9);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center}
  .card{width:100%;max-width:760px;background:rgba(255,255,255,0.06);padding:20px;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,0.4)}
  h1{margin:0 0 12px;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  label{display:block;font-size:13px;margin-bottom:6px;color:#e6eef0}
  input[type=text], input[type=url], textarea, input[type=number], select{
    width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.06);color:#fff;box-sizing:border-box
  }
  textarea{min-height:100px;resize:vertical}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  button{background:#06b6d4;border:none;padding:10px 14px;border-radius:8px;color:#04202a;font-weight:700;cursor:pointer}
  .muted{font-size:13px;color:#9fb6b9}
  .meta{margin-top:14px;background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;font-size:13px;color:#dff3f4}
  .status{margin-top:10px;font-weight:700}
  .small{font-size:12px;color:#bcdfe0}
  .flex-space{display:flex;justify-content:space-between;align-items:center}
  @media(min-width:720px){ .row .col-2{flex:1} .row .col-1{flex:0 0 200px} }
</style>
</head>
<body>
  <div class="card" role="main">
    <div class="flex-space">
      <h1>üîµ NGL ‚Äî Versi Kamu (dengan Info Pengirim)</h1>
      <div class="muted small">Host: GitHub Pages</div>
    </div>

    <form id="nglForm">
      <div class="row" style="margin-top:12px">
        <div class="col-2" style="flex:1;min-width:200px">
          <label for="username">Username tujuan (tanpa @)</label>
          <input id="username" type="text" placeholder="contoh: namakamu" required>
        </div>

        <div class="col-1" style="min-width:140px">
          <label for="count">Jumlah kirim</label>
          <input id="count" type="number" min="1" value="1" required>
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="message">Pesan</label>
        <textarea id="message" placeholder="Tulis pesan..." required></textarea>
      </div>

      <div style="margin-top:8px">
        <label for="webhook">Webhook URL (opsional ‚Äî simpan data pengirim di servermu)</label>
        <input id="webhook" type="url" placeholder="https://example.com/webhook">
        <div class="small">Isi webhook jika kamu punya server untuk menerima data (akan dikirim sebagai JSON).</div>
      </div>

      <div style="margin-top:10px;display:flex;gap:12px;align-items:center">
        <input id="includeMeta" type="checkbox" checked>
        <label for="includeMeta" style="margin:0">Sertakan info pengirim (IP publik, device, browser)</label>
      </div>

      <div class="controls">
        <button type="submit">Kirim</button>
        <button type="button" id="previewBtn">Preview Info Pengirim</button>
        <div class="muted small" style="align-self:center">Pastikan mematuhi privasi pengguna.</div>
      </div>

      <p class="status" id="status" aria-live="polite"></p>
    </form>

    <div id="metaBox" class="meta" style="display:none;white-space:pre-wrap"></div>

    <div style="margin-top:12px;font-size:13px;color:#bcdfe0">
      <strong>Catatan privasi:</strong> Data IP dan device dapat mengurangi anonimitas. Gunakan dengan bijak dan beri tahu pengirim.
    </div>
  </div>

<script>
(async function(){
  // Helper: ambil IP publik menggunakan ipify (bisa diganti layanan lain)
  async function getPublicIP() {
    try {
      const res = await fetch('https://api.ipify.org?format=json', {cache: 'no-store'});
      if (!res.ok) throw new Error('ip service error');
      const j = await res.json();
      return j.ip || 'unknown';
    } catch (e) {
      console.warn('Gagal ambil IP publik:', e);
      return 'unknown';
    }
  }

  // Ambil metadata device/browser
  function collectDeviceInfo() {
    const nav = navigator;
    const ua = nav.userAgent || 'unknown';
    // safe properties
    const info = {
      userAgent: ua,
      platform: nav.platform || 'unknown',
      language: nav.language || nav.languages?.[0] || 'unknown',
      cookieEnabled: !!nav.cookieEnabled,
      online: !!nav.onLine,
      hardwareConcurrency: nav.hardwareConcurrency || null,
      maxTouchPoints: nav.maxTouchPoints || 0,
      screen: { width: screen.width, height: screen.height, availWidth: screen.availWidth || null, availHeight: screen.availHeight || null, colorDepth: screen.colorDepth || null },
      timezoneOffsetMin: new Date().getTimezoneOffset()
    };
    return info;
  }

  // render metadata di UI
  function renderMetaBox(ip, meta) {
    const box = document.getElementById('metaBox');
    box.style.display = 'block';
    box.textContent = JSON.stringify({ ip, ...meta }, null, 2);
  }

  // main form handler
  const form = document.getElementById('nglForm');
  const status = document.getElementById('status');
  const previewBtn = document.getElementById('previewBtn');
  const includeMetaCheckbox = document.getElementById('includeMeta');

  // cache IP to avoid banyak panggilan
  let cachedIP = null;
  async function ensureIP() {
    if (cachedIP) return cachedIP;
    cachedIP = await getPublicIP();
    return cachedIP;
  }

  previewBtn.addEventListener('click', async () => {
    status.textContent = '‚è≥ Mengambil info...';
    const ip = await ensureIP();
    const meta = collectDeviceInfo();
    renderMetaBox(ip, meta);
    status.textContent = '‚ÑπÔ∏è Info pengirim ditampilkan di bawah.';
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    status.textContent = '‚è≥ Menyiapkan...';
    const username = document.getElementById('username').value.trim();
    const message = document.getElementById('message').value.trim();
    let count = parseInt(document.getElementById('count').value, 10);
    if (!count || count < 1) count = 1;
    const webhook = (document.getElementById('webhook').value || '').trim();
    const includeMeta = includeMetaCheckbox.checked;

    // kumpulkan metadata (opsional)
    const ip = includeMeta ? await ensureIP() : 'not-included';
    const meta = includeMeta ? collectDeviceInfo() : {};

    // tampilkan ringkasan di UI
    if (includeMeta) renderMetaBox(ip, meta);
    else document.getElementById('metaBox').style.display = 'none';

    // --- Kirim ke ngl.link (anonymous question) ---
    // Note: ngl.link expects form fields (username, question, deviceId, gameSlug, referrer)
    // CORS pada endpoint bisa berubah; jika gagal, kita laporkan di status.
    let sent = 0, failed = 0;
    for (let i = 0; i < count; i++) {
      status.textContent = `‚è≥ Mengirim ke ngl.link ‚Äî ${i+1}/${count}...`;
      try {
        const res = await fetch(`https://ngl.link/api/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
          body: new URLSearchParams({
            username: username,
            question: message,
            deviceId: '0',
            gameSlug: '',
            referrer: ''
          })
        });
        if (res.ok) {
          sent++;
        } else {
          failed++;
        }
      } catch (err) {
        console.warn('ngl.link send error', err);
        failed++;
      }
      // jeda kecil agar tidak terlalu cepat
      await new Promise(r => setTimeout(r, 800));
    }

    // --- Kirim metadata & isi pesan ke webhook (opsional) ---
    if (webhook) {
      status.textContent = '‚è≥ Mengirim salinan ke webhook...';
      try {
        const payload = {
          timestamp: new Date().toISOString(),
          target: username,
          message,
          attempts: count,
          result: { sent, failed },
          includeMeta,
          ip: includeMeta ? ip : null,
          meta: includeMeta ? meta : null
        };
        // kirim JSON ke webhook yang kamu sediakan
        await fetch(webhook, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.warn('Webhook error', err);
      }
    }

    status.textContent = `‚úÖ Selesai ‚Äî Terkirim: ${sent}, Gagal: ${failed}.${webhook ? ' (webhook dibuat jika diisi)' : ''}`;
  });
})();
</script>
</body>
        </html>
